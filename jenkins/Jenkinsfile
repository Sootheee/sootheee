pipeline {
    agent any
    environment {
        BRANCH_NAME = env.BRANCH_NAME
        COMMIT_AUTHOR = sh(script: "git log -1 --pretty=format:'%an'", returnStdout: true).trim()
        CHANGED_FILES = sh(script: "git diff --name-only origin/${env.BRANCH_NAME}...HEAD", returnStdout: true).trim()
        IS_PR = env.CHANGE_ID != null
    }
    stages {
        stage('Detect & Dispatch') {
            steps {
                script {
                    echo "=============================="
                    echo "ğŸ“ ë¸Œëœì¹˜: ${BRANCH_NAME}"
                    echo "âœï¸  ì»¤ë°‹ ì‘ì„±ì: ${COMMIT_AUTHOR}"
                    echo "ğŸ” íŠ¸ë¦¬ê±° ë°©ì‹: ${IS_PR ? 'PR' : 'Push'}"
                    echo "ğŸ“ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡:\n${CHANGED_FILES}"
                    echo "=============================="

                    def deployed = false

                    // â–¶ï¸ PR ì´ë²¤íŠ¸ì¼ ë•Œ
                    if (IS_PR) {
                        if (CHANGED_FILES =~ /client\// || COMMIT_AUTHOR == "ejaman") {
                            echo "ğŸš€ [PR] Front ë°°í¬ íŠ¸ë¦¬ê±°"
                            dir("jenkins") {
                                load (BRANCH_NAME == "main") ? "deploy-client-prod.Jenkinsfile" : "deploy-client-dev.Jenkinsfile"
                            }
                            deployed = true
                        }
                        if (CHANGED_FILES =~ /server\// || COMMIT_AUTHOR == "oocho0") {
                            echo "ğŸš€ [PR] Back ë°°í¬ íŠ¸ë¦¬ê±°"
                            dir("jenkins") {
                                load (BRANCH_NAME == "main") ? "deploy-server-prod.Jenkinsfile" : "deploy-server-dev.Jenkinsfile"
                            }
                            deployed = true
                        }
                    }

                    // â–¶ï¸ Push ì´ë²¤íŠ¸ì¼ ë•Œ (Jenkins ì„¤ì • ë³€ê²½ ë°˜ì˜ ëª©ì )
                    if (!IS_PR && CHANGED_FILES =~ /jenkins\//) {
                        echo "ğŸ”„ Jenkins êµ¬ì„± íŒŒì¼ ë³€ê²½ - ë‚´ë¶€ Jenkinsfile ì¬ë°˜ì˜ë¨"
                        deployed = true
                    }

                    if (!deployed) {
                        echo "âš ï¸ ì¡°ê±´ì— ë§ëŠ” ë°°í¬ íŠ¸ë¦¬ê±°ê°€ ì—†ìŠµë‹ˆë‹¤"
                        error("ğŸš« ë¹Œë“œ ì¢…ë£Œ: ë¶„ê¸° ì¡°ê±´ê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠìŒ")
                    }
                }
            }
        }
    }
}
